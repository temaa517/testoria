<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - Testoria</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }

        .stat-card.warning {
            border-left-color: #ffc107;
        }

        .stat-card.success {
            border-left-color: #28a745;
        }

        .stat-card.danger {
            border-left-color: #dc3545;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--muted-text);
            font-size: 0.9em;
        }

        .stat-change {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .change-positive {
            background: #d4edda;
            color: #155724;
        }

        .change-negative {
            background: #f8d7da;
            color: #721c24;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-color);
        }

        .chart-actions {
            display: flex;
            gap: 10px;
        }

        .time-filter {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text-color);
            cursor: pointer;
        }

        .time-filter.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .data-table {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .analytics-table th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .analytics-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .analytics-table tr:hover {
            background: var(--hover-color);
        }

        .metric-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .metric-good {
            background: #d4edda;
            color: #155724;
        }

        .metric-average {
            background: #fff3cd;
            color: #856404;
        }

        .metric-poor {
            background: #f8d7da;
            color: #721c24;
        }

        .export-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted-text);
        }

        .loading i {
            font-size: 2em;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞ -->
    <header class="header">
        <div class="container">
            <div class="header-inner">
                <div class="logo">
                    <h3>
                        <i class="fas fa-brain"></i>
                        Testoria
                    </h3>
                </div>
                <nav class="nav">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        –ì–ª–∞–≤–Ω–∞—è
                    </a>
                    <a href="catalog.html" class="nav-link">
                        <i class="fas fa-list"></i>
                        –ö–∞—Ç–∞–ª–æ–≥ —Ç–µ—Å—Ç–æ–≤
                    </a>
                    <a href="about.html" class="nav-link">
                        <i class="fas fa-info-circle"></i>
                        –û –Ω–∞—Å
                    </a>
                    <a href="contact.html" class="nav-link">
                        <i class="fas fa-phone"></i>
                        –ö–æ–Ω—Ç–∞–∫—Ç—ã
                    </a>
                    <a href="admin.html" class="nav-link">
                        <i class="fas fa-crown"></i>
                        –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                    </a>
                </nav>
                <div class="header-controls">
                    <button class="theme-toggle" id="themeToggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                        <span class="theme-thumb"></span>
                    </button>
                    <div id="profile-section" class="profile-dropdown">
                        <button class="profile-btn" id="profileBtn">
                            üë§ –ü—Ä–æ—Ñ–∏–ª—å
                        </button>
                        <div class="dropdown-content" id="profileDropdown">
                            <a href="profile.html">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
                            <a href="my-tests.html">–ú–æ–∏ —Ç–µ—Å—Ç—ã</a>
                            <a href="achievements.html">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</a>
                            <a href="results.html">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="page-content">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <section class="breadcrumbs">
            <div class="container">
                <nav class="breadcrumbs-nav">
                    <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                    <i class="fas fa-chevron-right"></i>
                    <a href="admin.html">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                </nav>
            </div>
        </section>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <section class="page-header">
            <div class="container">
                <div class="page-header-content">
                    <h1 class="page-title">
                        <i class="fas fa-chart-bar"></i>
                        –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    </h1>
                    <p class="page-subtitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Testoria</p>
                </div>
            </div>
        </section>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <section class="analytics-content">
            <div class="container">
                <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="stats-overview">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        <div class="stat-change change-positive" id="usersChange">+0%</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        <div class="stat-change change-positive" id="activeChange">+0%</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="testsCompleted">0</div>
                        <div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤</div>
                        <div class="stat-change change-positive" id="testsChange">+0%</div>
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
                <div class="charts-grid">
                    <!-- –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–Ω—è–º -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-calendar"></i>
                                –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º
                            </div>
                            <div class="chart-actions">
                                <button class="time-filter active" data-days="7">7 –¥–Ω.</button>
                                <button class="time-filter" data-days="30">30 –¥–Ω.</button>
                                <button class="time-filter" data-days="90">90 –¥–Ω.</button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>

                    <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–µ—Å—Ç–∞–º -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="testsChart"></canvas>
                        </div>
                    </div>

                    <!-- –í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-clock"></i>
                                –í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>

                    <!-- –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-graduation-cap"></i>
                                –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="resultsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
                <div class="data-table">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-table"></i>
                            –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </div>
                        <button class="export-btn" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                                    <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                                    <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTable">
                                <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- –§—É—Ç–µ—Ä -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>
                        <i class="fas fa-brain"></i>
                        Testoria
                    </h3>
                    <p>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ</p>
                    <div class="social-icons">
                        <a href="https://t.me/ttemkatut" class="social-link">
                            <i class="fab fa-telegram"></i>
                        </a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>
                        <i class="fas fa-compass"></i>
                        –ù–∞–≤–∏–≥–∞—Ü–∏—è
                    </h4>
                    <a href="index.html">
                        <i class="fas fa-arrow-right"></i>
                        –ì–ª–∞–≤–Ω–∞—è
                    </a>
                    <a href="catalog.html">
                        <i class="fas fa-arrow-right"></i>
                        –ö–∞—Ç–∞–ª–æ–≥ —Ç–µ—Å—Ç–æ–≤
                    </a>
                    <a href="about.html">
                        <i class="fas fa-arrow-right"></i>
                        –û –Ω–∞—Å
                    </a>
                    <a href="contact.html">
                        <i class="fas fa-arrow-right"></i>
                        –ö–æ–Ω—Ç–∞–∫—Ç—ã
                    </a>
                </div>
                <div class="footer-section">
                    <h4>
                        <i class="fas fa-envelope"></i>
                        –ö–æ–Ω—Ç–∞–∫—Ç—ã
                    </h4>
                    <p>
                        <i class="fas fa-envelope"></i>
                        Email: hello@testoria.cloud
                    </p>
                    <p>
                        <i class="fas fa-phone"></i>
                        –¢–µ–ª–µ—Ñ–æ–Ω: +375 (01) 234-56-78
                    </p>
                    <p>
                        <i class="fas fa-map-marker-alt"></i>
                        –ê–¥—Ä–µ—Å: –≥. –ú–∏–Ω—Å–∫, —É–ª. –£—Ä—É—á—Å–∫–∞—è, 21–ë
                    </p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>
                    <i class="far fa-copyright"></i>
                    2025 Testoria. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
                </p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
     <!-- –í –∫–æ–Ω—Ü–µ body, –ø–µ—Ä–µ–¥ –¥—Ä—É–≥–∏–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏ -->
<script src="js/custom-alerts.js"></script>
    <script src="auth-core.js"></script>
    <script src="auth-header.js"></script>
    <script>
    // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    class AnalyticsManager {
        constructor() {
            this.userManager = new UserManager();
            this.charts = {};
            this.currentTimeRange = 7;
            this.init();
        }

        init() {
            console.log('üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
            
            if (!this.checkAdminAccess()) {
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É Chart.js
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                this.showChartError();
                return;
            }

            console.log('‚úÖ Chart.js –¥–æ—Å—Ç—É–ø–µ–Ω');
            this.loadData();
            this.setupEventListeners();
            this.setupCharts();
        }

        showChartError() {
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted-text);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</h3>
                        <p>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Chart.js –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞</p>
                    </div>
                `;
            });
        }

        checkAdminAccess() {
            const user = this.userManager.getCurrentUser();
            
            if (!user) {
                window.location.href = 'login.html';
                return false;
            }

            if (!this.userManager.isAdmin(user)) {
                this.showAccessDenied();
                return false;
            }

            return true;
        }

        showAccessDenied() {
            document.querySelector('main').innerHTML = `
                <div class="container">
                    <div class="access-denied">
                        <i class="fas fa-lock"></i>
                        <h2>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
                        <p>–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.</p>
                        <a href="index.html" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
                    </div>
                </div>
            `;
        }

        loadData() {
            console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
            
            const users = this.userManager.getUsers();
            const testResults = JSON.parse(localStorage.getItem('testResults')) || [];
            
            this.calculateMetrics(users, testResults);
            this.updateOverview(users, testResults);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ —Å–æ–∑–¥–∞–Ω—ã
            if (Object.keys(this.charts).length > 0) {
                this.updateCharts(users, testResults);
            }
            
            this.updateMetricsTable(users, testResults);
        }

        calculateMetrics(users, testResults) {
            // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            this.metrics = {
                totalUsers: users.length,
                activeUsers: this.getActiveUsers(users),
                testsCompleted: testResults.length,
                avgScore: this.getAverageScore(testResults),
                avgTime: this.getAverageTime(testResults),
                retentionRate: this.getRetentionRate(users),
                popularTests: this.getPopularTests(testResults)
            };
        }

        getActiveUsers(users) {
            const now = new Date();
            return users.filter(user => {
                const created = new Date(user.createdAt);
                const diffTime = Math.abs(now - created);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 30;
            }).length;
        }

        getAverageScore(testResults) {
            if (testResults.length === 0) return 0;
            const total = testResults.reduce((sum, result) => sum + (result.score || 0), 0);
            return Math.round((total / testResults.length) * 100) / 100;
        }

        getAverageTime(testResults) {
            if (testResults.length === 0) return 0;
            const total = testResults.reduce((sum, result) => sum + (result.timeSpent || 0), 0);
            return Math.round(total / testResults.length);
        }

        getRetentionRate(users) {
            if (users.length === 0) return 0;
            const activeUsers = this.getActiveUsers(users);
            return Math.round((activeUsers / users.length) * 100);
        }

        getPopularTests(testResults) {
            const testCounts = {};
            testResults.forEach(result => {
                const testName = result.testTitle || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ—Å—Ç';
                testCounts[testName] = (testCounts[testName] || 0) + 1;
            });
            
            return Object.entries(testCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
        }

        updateOverview(users, testResults) {
            console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            this.ensureStatsElements();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
            const elements = {
                'totalUsers': this.metrics.totalUsers,
                'activeUsers': this.metrics.activeUsers,
                'testsCompleted': this.metrics.testsCompleted,
                'avgScore': this.metrics.avgScore + '%',
                'usersChange': '+12%',
                'activeChange': '+8%', 
                'testsChange': '+25%',
                'scoreChange': '+3%'
            };
            
            for (const [id, value] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`‚ùå –≠–ª–µ–º–µ–Ω—Ç ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                }
            }
            
            console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        }
        ensureStatsElements() {
            const statsContainer = document.querySelector('.stats-overview');
            if (!statsContainer) {
                console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            const statIds = ['totalUsers', 'activeUsers', 'testsCompleted', 'avgScore'];
            const changeIds = ['usersChange', 'activeChange', 'testsChange', 'scoreChange'];
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            statIds.forEach((id, index) => {
                if (!document.getElementById(id)) {
                    console.log(`üõ†Ô∏è –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç ${id}`);
                    const statCard = statsContainer.children[index];
                    if (statCard) {
                        const valueElement = document.createElement('div');
                        valueElement.id = id;
                        valueElement.className = 'stat-value';
                        valueElement.textContent = '0';
                        
                        const existingValue = statCard.querySelector('.stat-value');
                        if (existingValue) {
                            existingValue.replaceWith(valueElement);
                        }
                    }
                }
            });
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            changeIds.forEach((id, index) => {
                if (!document.getElementById(id)) {
                    console.log(`üõ†Ô∏è –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç ${id}`);
                    const statCard = statsContainer.children[index];
                    if (statCard) {
                        const changeElement = document.createElement('div');
                        changeElement.id = id;
                        changeElement.className = 'stat-change change-positive';
                        changeElement.textContent = '+0%';
                        
                        const existingChange = statCard.querySelector('.stat-change');
                        if (existingChange) {
                            existingChange.replaceWith(changeElement);
                        } else {
                            statCard.appendChild(changeElement);
                        }
                    }
                }
            });
        }
        setupCharts() {
            console.log('üìà –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤...');
            
            try {
                // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                const activityCtx = document.getElementById('activityChart');
                if (activityCtx) {
                    this.charts.activity = new Chart(activityCtx, {
                        type: 'line',
                        data: {
                            labels: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
                            datasets: [{
                                label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                                data: [12, 19, 8, 15, 22, 18, 25],
                                borderColor: '#4361ee',
                                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }
                        }
                    });
                }

                // –ì—Ä–∞—Ñ–∏–∫ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤
                const testsCtx = document.getElementById('testsChart');
                if (testsCtx) {
                    this.charts.tests = new Chart(testsCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['–¢–µ—Å—Ç 1', '–¢–µ—Å—Ç 2', '–¢–µ—Å—Ç 3'],
                            datasets: [{
                                data: [40, 30, 20],
                                backgroundColor: ['#4361ee', '#3a0ca3', '#7209b7']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }

                // –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–∏
                const timeCtx = document.getElementById('timeChart');
                if (timeCtx) {
                    this.charts.time = new Chart(timeCtx, {
                        type: 'bar',
                        data: {
                            labels: ['–¢–µ—Å—Ç 1', '–¢–µ—Å—Ç 2', '–¢–µ—Å—Ç 3'],
                            datasets: [{
                                label: '–í—Ä–µ–º—è (–º–∏–Ω)',
                                data: [8, 12, 6],
                                backgroundColor: '#7209b7'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }

                // –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                const resultsCtx = document.getElementById('resultsChart');
                if (resultsCtx) {
                    this.charts.results = new Chart(resultsCtx, {
                        type: 'bar',
                        data: {
                            labels: ['0-20%', '21-40%', '41-60%', '61-80%', '81-100%'],
                            datasets: [{
                                label: '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã',
                                data: [5, 10, 15, 20, 25],
                                backgroundColor: '#4cc9f0'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }

                console.log('‚úÖ –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
                this.showChartError();
            }
        }

        updateCharts(users, testResults) {
            console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤...');
            
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ
                const popularTests = this.metrics.popularTests;
                
                if (popularTests.length > 0 && this.charts.tests) {
                    this.charts.tests.data.labels = popularTests.map(t => t[0]);
                    this.charts.tests.data.datasets[0].data = popularTests.map(t => t[1]);
                    this.charts.tests.update();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                if (this.charts.results) {
                    const distribution = [0, 0, 0, 0, 0];
                    testResults.forEach(result => {
                        const score = result.score || 0;
                        if (score <= 20) distribution[0]++;
                        else if (score <= 40) distribution[1]++;
                        else if (score <= 60) distribution[2]++;
                        else if (score <= 80) distribution[3]++;
                        else distribution[4]++;
                    });
                    
                    this.charts.results.data.datasets[0].data = distribution;
                    this.charts.results.update();
                }

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
            }
        }

        updateMetricsTable(users, testResults) {
            const table = document.getElementById('metricsTable');
            if (!table) return;

            const metrics = [
                { name: '–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', value: this.metrics.totalUsers, change: '+12%', status: 'good' },
                { name: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', value: this.metrics.activeUsers, change: '+8%', status: 'good' },
                { name: '–ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤', value: this.metrics.testsCompleted, change: '+25%', status: 'good' },
                { name: '–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç', value: this.metrics.avgScore + '%', change: '+3%', status: 'average' },
                { name: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è', value: Math.round(this.metrics.avgTime / 60) + ' –º–∏–Ω', change: '-2%', status: 'good' },
                { name: '–£–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', value: this.metrics.retentionRate + '%', change: '+5%', status: 'good' },
                { name: '–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Ç–µ—Å—Ç', value: this.metrics.popularTests[0]?.[0] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', change: '0%', status: 'average' }
            ];
            
            table.innerHTML = metrics.map(metric => `
                <tr>
                    <td>${metric.name}</td>
                    <td>${metric.value}</td>
                    <td>${metric.change}</td>
                    <td>
                        <span class="metric-badge metric-${metric.status}">
                            ${metric.status === 'good' ? 'üìà –•–æ—Ä–æ—à–æ' : 
                            metric.status === 'average' ? 'üìä –°—Ä–µ–¥–Ω–µ' : 'üìâ –ü–ª–æ—Ö–æ'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        setupEventListeners() {
            // –§–∏–ª—å—Ç—Ä—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            document.querySelectorAll('.time-filter').forEach(button => {
                button.addEventListener('click', (e) => {
                    const days = parseInt(e.target.dataset.days);
                    this.currentTimeRange = days;
                    
                    document.querySelectorAll('.time-filter').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    this.loadData();
                });
            });

            // –ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('profileBtn')?.addEventListener('click', () => {
                this.toggleProfileMenu();
            });
        }

        toggleProfileMenu() {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            } else {
                dropdown.style.display = 'block';
                setTimeout(() => {
                    document.addEventListener('click', this.closeProfileMenu.bind(this), { once: true });
                }, 0);
            }
        }

        closeProfileMenu(e) {
            const dropdown = document.getElementById('profileDropdown');
            const profileBtn = document.getElementById('profileBtn');
            if (!dropdown.contains(e.target) && !profileBtn.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
    function exportData() {
        const userManager = new UserManager();
        const users = userManager.getUsers();
        const testResults = JSON.parse(localStorage.getItem('testResults')) || [];
        
        const data = {
            exportDate: new Date().toISOString(),
            users: users,
            testResults: testResults,
            metrics: {
                totalUsers: users.length,
                activeUsers: users.filter(u => {
                    const created = new Date(u.createdAt);
                    const diff = (new Date() - created) / (1000 * 60 * 60 * 24);
                    return diff <= 30;
                }).length,
                testsCompleted: testResults.length
            }
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `testoria-analytics-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        testoriaAlerts.success('‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON —Ñ–∞–π–ª');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
        new AnalyticsManager();
    });
</script>
</body>
</html>